# Franka Open Cabinet 机械臂开柜任务文档

## 概述

本文档详细描述了基于 Franka Emika Panda 机械臂的柜子打开（Open Cabinet）任务环境。该环境是 MotrixLab 项目的一部分，提供了使用强化学习训练机械臂执行接近柜门把手、抓取把手并拉开抽屉的完整实现。

| | |
| :--- | :--- |
| **动作空间** | `Box(-inf, inf, (8,), float32)` |
| **观测空间** | `Box(-inf, inf, (25,), float32)` |
| **导入方式** | `registry.make("franka_open_cabinet", backend="np")` |

-----

## 环境描述

Franka Open Cabinet 任务环境基于 Franka Emika Panda 七轴机械臂构建，旨在训练机械臂在仿真环境中操作柜体抽屉。该环境使用 MotrixSim 物理引擎进行仿真。

### 环境组成

#### 机械臂

Franka Panda 是一个高精度的轻量级机械臂，由以下主要部分组成：

  * **机械臂本体**：包含7个旋转关节（Joint 1-7）。
  * **末端执行器（Gripper）**：包含两个指关节（finger\_joint1, finger\_joint2），但在动作空间中被简化为一个控制维度。

#### 目标物体

  * **柜子（Cabinet）**：包含一个可滑动的抽屉（Drawer）。
  * **交互部位**：抽屉把手（Handle），机械臂需要通过该部位施加力以改变抽屉状态。

### 任务目标

机器人需要完成以下操作流程：

1.  **接近把手**：末端执行器移动到柜子抽屉把手的位置。
2.  **调整姿态**：调整末端姿态（四元数）以匹配把手的朝向。
3.  **抓取把手**：控制夹爪闭合以握住把手。
4.  **拉开抽屉**：向后移动机械臂，带动抽屉滑轨运动，将抽屉拉开。

-----

## 动作空间

动作空间为 `Box(-inf, inf, (8,), float32)`，前7维用于控制机械臂的关节运动，最后一维控制夹爪的开闭。

### 控制模式

环境采用混合控制模式：前7维为关节位置偏移控制，最后1维为夹爪的二元开闭控制（闭合/打开）。

**1. 机械臂关节 (Dim 0-6):**

```python
目标关节角度 = 当前关节角度 + 动作值 (作为偏移量)
```

注意：最终的关节角度会被截断在 `control_config.min_pos` 和 `max_pos` 之间。

**2. 夹爪控制 (Dim 7):**
夹爪的二元开闭控制动作采用**伯努利概率采样**实现：

  * 输入值 `action[7]` 经过 Sigmoid 函数映射为概率 $p = 1 / (1 + e^{-action[7]})$。
  * 生成随机数 $r \sim U(0, 1)$。
  * 若 $r < p$，输出 `0` (闭合夹爪，尝试抓取)；否则输出 `0.04` (打开夹爪，释放)。

### 动作维度详细说明

策略输出的动作定义为各个关节的位置偏移量（Position Offset），其每一个维度对应机械臂的一个关节执行器（Actuator）。

底层仿真使用位置执行器（Position Actuator）进行驱动，具体的 PD 控制参数（KP 比例增益 / KV 微分增益）与物理限制定义在 MJCF 文件（`mjx_panda.xml`）的 `<actuator>` 标签中。

`mjx_panda.xml` 定义的 Actuator 物理限制与控制参数的详细列表：

| 编号 | 关节说明 | 控制范围 (CtrlRange) | 对应关节名称 | 关节类型 | KP (P增益) | KV (D增益) | 单位 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 0 | 关节1旋转 (基座) | -2.8973 \~ 2.8973 | joint1 | hinge | 1000 | 20 | rad |
| 1 | 关节2旋转 | -1.7628 \~ 1.7628 | joint2 | hinge | 1000 | 20 | rad |
| 2 | 关节3旋转 | -2.8973 \~ 2.8973 | joint3 | hinge | 750 | 4 | rad |
| 3 | 关节4旋转 (肘部) | -3.0718 \~ -0.0698 | joint4 | hinge | 750 | 4 | rad |
| 4 | 关节5旋转 | -2.8973 \~ 2.8973 | joint5 | hinge | 300 | 2 | rad |
| 5 | 关节6旋转 | -0.0175 \~ 3.7525 | joint6 | hinge | 300 | 2 | rad |
| 6 | 关节7旋转 (腕部) | -2.8973 \~ 2.8973 | joint7 | hinge | 300 | 2 | rad |
| 7 | 夹爪开合控制 | 0 (闭) \~ 0.04 (开) | finger\_joint1 | slide | 350 | - \* | m |

> **注**：夹爪（Actuator 8）在配置文件中使用 `<general>` 执行器，其刚度（KP）由 `gainprm="350..."` 设定，未显式设定 Actuator 级的 KV，阻尼主要依赖关节自身的物理阻尼（`damping="10"`）。

-----

## 观测空间

观测空间为 `Box(-inf, inf, (25,), float32)`，包含机器人的关节状态、末端相对于把手的位姿差、以及抽屉的状态。

### 观测组成部分

观测向量由以下部分组成（按顺序拼接）：
| 编号 | 观测内容 | 维度 |
| :--- | :--- | :--- | 
| 0-7 | 关节相对位置 | 8 | 
| 8-15 | 关节相对速度 | 8 | 
| 16-22 | 相对目标位姿 | 7 | 
| 23 | 抽屉关节位置 | 1 | 
| 24 | 抽屉关节速度 | 1 |

### 观测详细说明


1.  **关节相对位置 (Scaled)（8维）**：
      * 当前关节角度（7个臂关节+1个指关节）归一化处理后的值，范围约为 [-1, 1]。
2.  **关节相对速度（8维）**：
      * 当前关节速度减去初始速度（初始为0），并除以2进行缩放。
3.  **相对目标位姿（7维）**：
      * 抽屉把手位姿（`drawer_grasp_pose`）减去 机械臂末端位姿（`robot_grasp_pose`）。包含位置差（3维）和四元数差（4维）。
4.  **抽屉关节位置（1维）**：
      * 抽屉当前的拉开距离（`drawer_top_joint_pos`）。
5.  **抽屉关节速度（1维）**：
      * 抽屉当前的运动速度（`drawer_top_joint_vel`）。



-----

## 奖励函数

奖励函数采用复合设计，旨在引导机器人完成对齐、抓取、拉开抽屉的任务。奖励权重根据训练阶段（步数）动态调整。

### 任务奖励项

1.  **距离奖励 (Distance Reward)**

      * 计算公式：`1 - tanh(gripper_drawer_dist / 0.1)`
      * 系数：10
      * 目的：激励末端执行器快速靠近抽屉把手。

2.  **姿态对齐奖励 (Orientation Reward)**

      * 计算方法：计算末端四元数与把手四元数的角度差 $\theta$，奖励值为 $\cos(\theta)$。
      * 目的：引导机械臂调整手腕角度以匹配把手方向。

3.  **夹爪操作奖励 (Gripper Action Reward)**

      * **闭合奖励**：当末端与把手距离 \< 0.025m 时，鼓励闭合夹爪（奖励系数 100.0）。
      * **张开惩罚**：当末端与把手距离 \> 0.025m 时，如果闭合夹爪则给予惩罚（系数 -20），即鼓励张开。
      * 公式项：`Reward_Scale * (0.04 - current_gripper_action)`。

4.  **开柜奖励 (Open Drawer Reward)**

      * 计算公式：`  (exp(open_dist) - 1) * 20 `
      * 限制条件：`open_dist` 被截断在 [0, 1] 之间。
      * **防作弊机制**：若 `wrong_open` 为真（即抽屉被拉开但夹爪距离把手 \> 0.03m，意味着是被撞开的），则不给予此项奖励。

### 惩罚项

1.  **动作变化惩罚 (Action Penalty)**
      * 惩罚动作的剧烈变化：`sum((current_action - last_action)^2)`。
2.  **关节速度惩罚 (Joint Velocity Penalty)**
      * 惩罚过大的关节速度：`sum(joint_vel^2)`。
3.  **手指位置惩罚 (Finger Dist Penalty)**
      * 确保左右手指（left/right finger pads）正对于把手两侧，防止手指插偏。

**动态权重调整：**

  * **前 12000 步**：
      * 动作变化惩罚率：`1e-3` (1e-4 \* 10)
      * 关节速度惩罚率：`0`
  * **12000 步后**：
      * 动作变化惩罚率：`2e-3` (2e-4 \* 10)
      * 关节速度惩罚率：`2e-7` (2e-8 \* 10)

-----

## 初始状态

### 机器人初始化

**关节初始化：**

  * 机器人关节初始化为 `robot_default_joint_pos`。
  * 施加随机噪声：在 `[-0.125, 0.125]` 范围内均匀采样添加到初始关节角度。

### 环境物体初始化

  * **机械臂与柜子位置**：在 `reset` 函数中，通过 `data.set_dof_pos` 将机械臂关节位置和柜子（包含抽屉）的关节位置一并重置。柜子默认为关闭状态（关节位置为0）。

-----

## 回合终止

### 终止条件 (Truncated)

环境在以下任一条件满足时终止回合（Truncated 为 True）：

1.  **超时终止**

      * 条件：回合步数超过 `max_episode_steps`（对应 5.0s）。

2.  **碰撞/位置异常**

      * 条件：机械臂末端 X 坐标比抽屉把手 X 坐标小 0.03m 以上（`robot_x - drawer_x < -0.03`），防止机械臂过度前伸穿模或发生非自然碰撞。

3.  **速度异常**

      * 条件：任一关节速度绝对值超过 5 rad/s。

-----

## 配置参数

Franka Open Cabinet 环境通过 `FrankaOpenCabinetEnvCfg` 类进行配置。

### 关键配置参数说明

| 参数类别 | 参数名称 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| **基础配置** | max\_episode\_seconds | 5.0 | 单回合最大时长 (秒) |
| | sim\_dt | 0.01 | 仿真步长 |
| | ctrl\_dt | 0.01 | 控制步长 |
| | move\_speed | 1.0 | 移动速度系数 (未在逻辑中显式调用) |
| **控制配置** | control\_config.joint\_pos\_reset\_noise | 0.125 | 机械臂关节角度初始随机噪声范围 |
| | control\_config.min\_pos | [List] | 关节位置下限 |
| | control\_config.max\_pos | [List] | 关节位置上限 |

-----

## 版本历史

### v1.0

**核心功能：**

  * 实现基于 Franka Panda 的 Open Cabinet 任务。
  * 引入四元数姿态对齐奖励。
  * 设计了基于距离的动态夹爪开闭引导奖励。
  * 包含防止“撞开抽屉”的防作弊逻辑。

-----
## 使用示例

### 基本使用

模型训练示例
```python
uv run ./scripts/train.py --env franka_open_cabinet  --num-envs 4096  # --render 可选是否进行渲染
```

模型运行示例
```python
uv run ./scripts/play.py --env franka_open_cabinet  --num-envs 20
```
-----

## 常见问题

### 1\. 机械臂运动抖动与控制精度不足

**可能原因：**

  * `sim_dt`（仿真步长）与 `ctrl_dt`（控制步长）配合不佳。仿真步长过大影响物理计算稳定性，控制步长过大会导致控制不够细腻。
  * 位置控制器的 PD 参数设置不合理，特别是 D 参数（微分项）过小，导致阻尼不足。

**解决方案：**

  * **统一时间步长**：建议将仿真参数 `sim_dt` 和 `ctrl_dt` 均设置为 `0.01` (100Hz)。
  * **调整 PD 参数**：D 参数过小是导致抖动的重要原因。建议将 xml 模型中 actuator 的 D 参数调整为 P 参数开平方的 2 倍（即 $D = 2\sqrt{P}$），以达到临界阻尼状态，抑制震荡。
  * **预期效果**：调整后机械臂动作会变得非常柔顺，抖动消失，且能更精确地到达微小目标区域。

### 2\. 仿真崩溃 (Simulation Crash/NaN/Inf)

**可能原因：**

  * **关节速度过大**：导致物理引擎计算发散，出现 `NaN` 或 `Inf`。

**解决方案：**

  * 代码中已内置 `check_termination` 机制，当 `joint_vel > 5` 时自动截断回合。
  * 检查 `apply_action` 中的 `clip` 逻辑，确保目标位置在物理限制范围内。

### 3\. 夹爪与把手接触穿模

**现象：**
机械臂到达把手位置，但二者未发生碰撞而是直接穿过。

**可能原因：**

  * xml文件中机械臂夹爪与把手的碰撞组不一致。
  * xml中把手的碰撞属性设置有问题。

**解决方案：**

  * 检查 xml 文件中机械臂夹爪与把手的碰撞组是否一致。
  * 检查夹爪和把手的碰撞网格是否正常。

-----

## 引用

如果您在研究中使用此环境，请引用：

```
@misc{motrixlab_anymalc_nav,
  title={ANYmal-C Navigation Task Environment},
  author={MotrixLab Contributors},
  year={2025},
  publisher={GitHub},
  url={https://github.com/your-repo/MotrixLab}
}
```


-----

## 许可证

本环境遵循 Apache License 2.0 开源协议。

---

## 相关资源

- **MotrixSim 文档**：[链接待补充]
- **ANYmal-C 机器人官方资料**：https://www.anybotics.com/
- **Gymnasium 文档**：https://gymnasium.farama.org/
- **训练示例脚本**：`scripts/train.py`
- **可视化脚本**：`scripts/view.py`